name: CI/CD Pipeline
# è§¦å‘æœºåˆ¶ï¼šå½“ä»£ç  Push åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è¿è¡Œ
on:
push:
branches: [ main ]
jobs:
# === ä»»åŠ¡ 1: æ„å»ºå¹¶æ¨é€é•œåƒ ===
build-and-push:
runs-on: ubuntu-latest
steps:
- name: ğŸ“¥ æ£€å‡ºä»£ç  (Checkout)
uses: actions/checkout@v4
- name: ğŸ³ ç™»å½• Docker Hub
uses: docker/login-action@v3
with:
username: ${{ secrets.DOCKER_USERNAME }}
password: ${{ secrets.DOCKER_PASSWORD }}
- name: ğŸ”¨ æ„å»ºå¹¶æ¨é€é•œåƒ
uses: docker/build-push-action@v5
with:
context: .
push: true
# æ ‡è®°é•œåƒç‰ˆæœ¬ï¼šlatest
tags: ${{ secrets.DOCKER_USERNAME }}/project-alpha:latest
# === ä»»åŠ¡ 2: éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨ ===
deploy:
needs: build-and-push # åªæœ‰ä»»åŠ¡ 1 æˆåŠŸäº†æ‰æ‰§è¡Œéƒ¨ç½²
runs-on: ubuntu-latest
steps:
- name: ğŸš€ SSH è¿œç¨‹éƒ¨ç½²
uses: appleboy/ssh-action@v1.0.3
with:
host: ${{ secrets.HOST_IP }}
username: ubuntu
key: ${{ secrets.SSH_PRIVATE_KEY }}
script_stop: true # å¦‚æœè„šæœ¬å‡ºé”™ç«‹å³åœæ­¢
# è¿œç¨‹æ‰§è¡Œçš„ Shell è„šæœ¬
script: |
echo "--- å¼€å§‹éƒ¨ç½²æµç¨‹ ---"
# 1. åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨ (å¦‚æœå­˜åœ¨)
# || true è¡¨ç¤ºå³ä½¿å®¹å™¨ä¸å­˜åœ¨ä¹Ÿä¸æŠ¥é”™ï¼Œç»§ç»­æ‰§è¡Œ
docker stop my-app || true
docker rm my-app || true
# 2. æ‹‰å– Docker Hub ä¸Šçš„æœ€æ–°é•œåƒ
echo "æ­£åœ¨æ‹‰å–æœ€æ–°é•œåƒ..."
docker pull ${{ secrets.DOCKER_USERNAME }}/project-alpha:latest
# 3. å¯åŠ¨æ–°å®¹å™¨
echo "å¯åŠ¨æ–°å®¹å™¨..."
docker run -d \
--name my-app \
--restart always \
-p 8080:8080 \
${{ secrets.DOCKER_USERNAME }}/project-alpha:latest
echo "--- éƒ¨ç½²å®Œæˆ ---"