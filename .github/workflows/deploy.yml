name: CI/CD Pipeline
# è§¦å‘æœºåˆ¶ï¼šå½“ä»£ç  Push åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è¿è¡Œ
on:
  push:
    branches: [ main ]
jobs:
  # === ä»»åŠ¡ 1: æ„å»ºå¹¶æ¨é€é•œåƒ ===
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç  (Checkout)
        uses: actions/checkout@v4
      - name: ğŸ³ ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: ğŸ”¨ æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/project-alpha:latest

  # === ä»»åŠ¡ 2: éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨ ===
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ SSH è¿œç¨‹éƒ¨ç½²
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          # ç®€åŒ–è„šæœ¬ï¼Œå¢åŠ å®¹é”™ï¼Œé¿å…å®¹å™¨åå†²çª
          script: |
            echo "SSHè¿æ¥æˆåŠŸï¼Œå¼€å§‹éƒ¨ç½²"
            # å¼ºåˆ¶åˆ é™¤æ—§å®¹å™¨ï¼ˆæ— è®ºæ˜¯å¦è¿è¡Œï¼‰
            docker rm -f my-app 2>/dev/null || true
            # æ‹‰å–é•œåƒï¼ˆå¿½ç•¥é”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œï¼‰
            docker pull ${{ secrets.DOCKER_USERNAME }}/project-alpha:latest || true
            # å¯åŠ¨æ–°å®¹å™¨ï¼ˆä½¿ç”¨--rmç¡®ä¿é€€å‡ºåè‡ªåŠ¨æ¸…ç†ï¼‰
            docker run -d \
              --name my-app \
              --restart unless-stopped \
              -p 8080:8080 \
              ${{ secrets.DOCKER_USERNAME }}/project-alpha:latest
            echo "éƒ¨ç½²å®Œæˆï¼Œå®¹å™¨å·²å¯åŠ¨"